<!DOCTYPE html>
<html>

<head>
    <title>Profile</title>
    <style>
        .informationDiv {
            width: 80%;
            height: 550px;
            background-color: rgba(255, 255, 255, 0.8);
            margin: 0 auto;
            padding: 10px;
            overflow-y: auto;
        }
    </style>
    <script>
        var key = "AIzaSyDWvmjDzvFJUxU6J8ktMP9HQIuUuXchWLg";

        function loadComment() {
            var commentSection = document.getElementById("showComments");
            var username = localStorage.getItem("user");

            var xhttp = new XMLHttpRequest();
            xhttp.responseType = 'text';
            xhttp.open("post", "../php/discussionUserList.php?username=" + username, true);
            xhttp.onreadystatechange = function () {
                var bookTable = document.createElement("table");
                if (xhttp.readyState == 4) {
                    if (xhttp.status == 200) {
                        console.log(xhttp.responseText);
                        var commentsList = xhttp.responseText.split("|");

                        for (let i = 1; i < commentsList.length; i++) {


                            var temp = commentsList[i].split(",")
                            console.log(temp);
                            var xhttp2 = new XMLHttpRequest();
                            xhttp2.responseType = 'json';
                            var query = "https://www.googleapis.com/books/v1/volumes/" + temp[0] + "?key=" + key;
                            xhttp2.open("get", query, true);

                            xhttp2.onreadystatechange = function () {
                                if (xhttp2.readyState == 4) {
                                    if (xhttp2.status == 200) {
                                        var stringified = JSON.stringify(xhttp2.response);
                                        var parsedObj = JSON.parse(stringified);

                                        // Get image test
                                        var img;
                                        // console.log(xhtt);
                                        console.log(parsedObj.volumeInfo);
                                        if (parsedObj.volumeInfo.imageLinks === undefined) {
                                            img = "https://upload.wikimedia.org/wikipedia/commons/thumb/f/fc/No_picture_available.png/128px-No_picture_available.png";
                                        }
                                        else {
                                            img = JSON.stringify(parsedObj.volumeInfo.imageLinks.thumbnail).replace('"', "");
                                        }
                                        var thumbnail = document.createElement("img");
                                        thumbnail.src = img;
                                        var tr = document.createElement("tr");
                                        var td = document.createElement("td");
                                        td.appendChild(thumbnail);
                                        tr.append(td)
                                        bookTable.appendChild(tr);


                                        // Add titles and stuff
                                        var title = JSON.stringify(parsedObj.volumeInfo.title).replaceAll('"', "");
                                        var author = "N/A";
                                        if (parsedObj.volumeInfo.authors != undefined) {
                                            var author = JSON.stringify(parsedObj.volumeInfo.authors[0]).replaceAll('"', "");
                                        }
                                        td = document.createElement("td");
                                        td.appendChild(document.createTextNode(title + " - " + author));
                                        tr.appendChild(td);
                                        bookTable.appendChild(tr);
                                    }
                                }
                            }
                            xhttp2.send();
                        }
                        commentSection.appendChild(bookTable);
                    }
                }
            };
            xhttp.send();
        }
    </script>

</head>

<body onload="loadComment()">
    <h1>Profile</h1>
    <table>
        <tr>
            <td>Change Username: </td>
            <td><input style="width: 200px;"></td>
        </tr>
    </table>
    <div class="informationDiv" id="showComments"></div>
</body>

</html>